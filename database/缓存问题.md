# 缓存问题


- 缓存穿透
- 缓存并发
- 缓存失效
- 二级缓存[待更]

## 缓存穿透

我们在项目中使用缓存通常是先检查缓存是否命中，命中则返回缓存内容，若不存在查询数据库命中之后再做缓存并返回结果。但如果查询缓存每次都不命中的话，就会造成每一次都查询数据库，缓存就失去了意义，在流量大的时候数据库就有可能挂掉，这是一个可能遭到恶意攻击的漏洞。

一种解决方案是在缓存不命中的情况下，访问一个特定的value，比如"cache miss"，前台根据这个暗号来决定等待多长时间继续访问或者是放弃操作。后台可以线程池来控制缓存不命中的情况，避免高并发访问数据库造成崩溃。

## 缓存并发

如果有一个缓存突然失效，在高并发的情况下，可能出现多个进程（线程）查询数据库，并同时设置缓存的情况，这会造成数据压力过大，还有缓存频繁更新的问题。

一种解决方案是对缓存查询进行加锁，如果当前查询的key不存在，加锁并查询数据库加入缓存。其他进程（线程）访问加锁的key可以等待锁释放。

## 缓存失效

如果多个缓存突然同时失效，在高并发情况下，可能在某个时间点同时设置多个缓存，并设置相同的失效时间，缓存一旦过期，高并发的访问缓存不命中，从而高并发的访问数据库，可能造成数据库崩溃。

一种解决方案设置缓存的过期时间为baseTime+randomTime，这样就很难造成缓存同时失效的问题，从而引发缓存雪崩的问题。


## 二级缓存



## 其他问题

- 数据库和缓存可能出现网络通信的问题，往数据库增加一条数据之后，通过缓存查询由于网络问题，查询并不能命中。可以启动一个线程任务定时检测缓存服务器是否连接成功，用于监控通信问题，具体做法：当缓存不命中的时候，可由监控尝试去访问数据库，进行比对，从而判断缓存服务器和数据库是否存在通信问题，监控线程是否更新缓存，就由业务决定了。

- 缓存与数据库会存在一致性的问题，同步是会存在时间差的。

